# PS doesn't support multi-statements
--disable_ps_protocol
--source include/have_binlog_format_row.inc

set global rds_audit_log_enabled = ON;
set global rds_audit_log_flush = on;
--disable_query_log
set global rds_audit_log_version = 'MYSQL_V1';
--enable_query_log
set global local_infile = on;
let $rds_audit_file = `select VARIABLE_VALUE from performance_schema.global_status where variable_name = 'RDS_AUDIT_LOG_FILENAME'`;
create table t1(id int primary key) engine = innodb;

create table auditlog(v varchar(1280));

create user xx1@'%';
grant all on test to xx1@'%';
create user xx2@'%';
grant all on test to xx2@'%';
create user xx3@'%';
grant all on test to xx3@'%';
create user xx4@'%';
grant all on test to xx4@'%';
create user xx5@'%';
grant all on test to xx5@'%';

connect(conn_xx1, localhost, xx1,,);
insert into t1 values(1);

--disable_query_log
--error 1045
connect(conn_xx2, localhost, xx2, 123,);
--enable_query_log
connect(conn_xx2, localhost, xx2,,);
insert into t1 values(2);

connect(conn_xx3, localhost, xx3,,);
insert into t1 values(3);
disconnect conn_xx3;

connect(conn_xx4, localhost, xx4,,);
insert into t1 values(4);
disconnect conn_xx4;

connect(conn_xx5, localhost, xx5,,);
insert into t1 values(5);

--error 1062
insert into t1 values(1);
--error 1136
insert into t1 values(6,6);

delete from t1;

create table t_long(name varchar(2096))engine=innodb;
insert into t_long values
("1234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456");
insert into t_long values
("12345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678");
insert into t_long values
("1234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678");
drop table t_long;

let $1= 20;
while($1)
{
  eval insert into t1 values($1);
  dec $1;
}

set autocommit=0;
--sleep 1
update t1 set id = id + 20;
update t1 set id = id * 2 where id & 1 = 0;
select * from t1 where id = 17;
delete from t1 where id = 17;
select * from t1 where id = 17;
commit;
set autocommit=1;

connection default;
set global rds_audit_log_event_buffer_size= 35;

SET GLOBAL event_scheduler=off;
create table event_test (id int) engine = innodb;
drop event if exists event1;
create event event1 on schedule every 1 second starts now() ends date_add(now(), interval 5 hour) DO insert into event_test values(1);
SET GLOBAL event_scheduler=ON;
--sleep 3
SET GLOBAL event_scheduler=off;
drop table event_test;
drop event event1;

create table proc_test(id int) engine = innodb;
DELIMITER //;
CREATE PROCEDURE proc1()
BEGIN
insert into proc_test values(1);
END
//
DELIMITER ;//
call proc1();
drop procedure proc1;
drop table proc_test;

connection conn_xx1;
create table t2(id int primary key auto_increment, code varchar(10)) engine = innodb;
insert into t2 (code) values("abc");

insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;
insert into t2 (code) select code from t2;

alter table t2 engine = innodb;

update t2 set code = '123' where id & 3 = 0;
update t2 set code = 'adb' where id & 3 = 1;
update t2 set code = 'ooo5' where id & 3 = 2;
update t2 set code = '##$' where id & 3 = 3;

create temporary table t3(id int) engine = innodb;

prepare t3_insert from "insert into t3 values(1)";
execute t3_insert;
SET @v0 = '2';
PREPARE stmt FROM 'UPDATE t3 SET id = ?';
EXECUTE stmt USING @v0;
DEALLOCATE PREPARE stmt;

drop table t3;

--disable_result_log
select * from t2 order by code desc;
delete from t2 where id & 1;
--enable_result_log

# Make sure all audit logs have been flushed to disk
connection default;
set global rds_audit_log_enabled = off;
set global rds_audit_log_enabled = on;
connection conn_xx1;

--disable_warnings
--disable_query_log
eval load data local infile '$rds_audit_file' into table auditlog FIELDS TERMINATED BY ',';
--enable_query_log
select count(*)>0 from auditlog where v like '%MYSQL_V1%' and v like '%xx%';
select count(*)>0 from auditlog where v like '%insert into t2 (code) values("abc")%';
select count(*)>0 from auditlog where v like '%xx1%' and v like '%login%';
select count(*)>0 from auditlog where v like '%xx2%' and v like '%login%';
select count(*)>0 from auditlog where v like '%xx3%' and v like '%login%';
select count(*)>0 from auditlog where v like '%xx4%' and v like '%login%';
select count(*)>0 from auditlog where v like '%xx5%' and v like '%login%';
select count(*)>0 from auditlog where v like '%xx3%' and v like '%logout%';
select count(*)>0 from auditlog where v like '%xx4%' and v like '%logout%';
--enable_warnings

connection default;
drop table t1;
drop table t2;
drop table auditlog;
drop user xx1@'%';
drop user xx2@'%';
drop user xx3@'%';
drop user xx4@'%';
drop user xx5@'%';

set global rds_audit_log_enabled = default;
set global rds_audit_log_event_buffer_size = default;
set global local_infile = default;
set global rds_audit_log_version = default;
disconnect conn_xx1;
disconnect conn_xx2;
disconnect conn_xx5;
SET GLOBAL event_scheduler=default;
